[English](./README.md) ｜ 中文

# OS Detector

## 描述
这是一个基于TCP/IP栈指纹识别技术的操作系统检测工具，使用Go语言实现。该工具参考了nmap的操作系统检测原理，能够通过分析网络数据包的特征来识别目标主机运行的操作系统类型。

## 功能特点

- 支持通过ICMP和TCP进行主机存活检测
- 支持通过TCP指纹识别操作系统
- 支持通过SMB协议检测操作系统
- 分析TCP头部特征（窗口大小）
- 支持多种操作系统的识别（Windows、Linux、macOS）
- 提供详细的检测过程日志

## 使用方法
```bash
# 安装依赖
go mod tidy

# 运行 (需要sudo，不然可能无法发ICMP请求)
sudo go run main.go -t 192.168.1.1  # 指定目标IP地址
sudo go run main.go -t 192.168.1.1 -v  # 显示详细信息
```

## 实现原理

该工具使用多种检测方法来识别目标操作系统：

1. 主机存活检测
   - ICMP ping
   - TCP端口扫描
2. TCP指纹识别
   - TCP窗口大小分析
   - 常用端口扫描（80、443、22、445）
3. SMB协议分析
   - SMB版本检测
   - 操作系统信息提取

### 检测流程

1. 使用ICMP和TCP进行主机存活检测
2. TCP指纹分析
3. SMB协议检测（如果可用）
4. 综合结果确定最终操作系统类型

### 运行案例
```bash
xuemian@MacBookPro osDetector %  go run main.go -t 192.168.110.71 -v
17:03:34 开始对目标: 192.168.110.71 进行操作系统识别
17:03:40 目标主机端口 135 开放，确认存活
17:03:40 开始使用TCP端口检测操作系统类型
[TCP test] OS options are: FreeBSD, Palm OS, Centos, Symbian, Ubuntu, Debain, Linux, Windows XP, Windows 7, Windows 10, Windows 11
17:03:47 检测到Windows特征端口 135 开放，可能是Windows系统
17:03:47 找到开放端口 135，TTL=128, DF=true, WinSize=8192, MSS=1440
17:03:47 找到开放端口 135，TTL=128, DF=true, WinSize=8192, MSS=1440
[TTL Analysis] TTL=128, Estimated initial TTL=128, OS options: Windows XP, Windows 7, Windows 10, Windows 11
[TCP test] IP layer OS options are: Windows 10, Windows 11, Windows XP, Windows 7
[TCP test] TCP layer OS options are: Windows 10, Windows XP, Windows 7
17:03:47 TCP检测结果为： Windows XP, Windows 7, Windows 10
17:03:47 检测到Windows特征端口 135，根据端口特征调整Windows系统权重
17:03:47 开始使用SMB端口检测操作系统类型
[SMB test] OS options are: Windows XP, Symbian, Centos, Linux, Windows 7, Windows 10, Windows 11, Palm OS, Ubuntu, Debain, FreeBSD
>>> SMB WRITE 4 bytes: 000000ae
>>> SMB WRITE 174 bytes: fe534d4240000100000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000500010000004400000077e3d93beb914e4166ca54a91339667c700000000200000011030203000310020202000001002600000000000100200001007859d7176aa8fbe3bc9bb39dbb44a48ac1d66a4d52c990fc0efe2a4cb12158b600000200060000000000020002000100
<<< SMB READ 4 bytes: 000000ec
<<< SMB READ 236 bytes: fe534d424000010000000000000001000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004100010011030200ce94c5ca35e4ff45a841588bb67c680807000000000080000000800000008000b9950b8a1da9db01000000000000000080002a00b0000000602806062b0601050502a01e301ca01a3018060a2b06010401823702021e060a2b06010401823702020a00000000000001002600000000000100200001009278de75d8e43044479af5733489e59bce5a66d25155acce90995c613a50d3d30000020004000000000001000200
>>> SMB WRITE 4 bytes: 000000a2
>>> SMB WRITE 162 bytes: fe534d42400001000000000001007e0000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000019000001000000000000000058004a000000000000000000604806062b0601050502a03e303ca00e300c060a2b06010401823702020aa22a04284e544c4d5353500001000000158288e2000000000000000000000000000000000a0000000000000f
<<< SMB READ 4 bytes: 00000157
<<< SMB READ 343 bytes: fe534d4240000100160000c0010001000100000000000000010000000000000000000000000000002d00000000bc0000000000000000000000000000000000000900000048000f01a182010b30820107a0030a0101a10c060a2b06010401823702020aa281f10481ee4e544c4d53535000020000001e001e003800000015828ae265c82f5c88e4a8fa000000000000000098009800560000000a005d580000000f4400450053004b0054004f0050002d00380037004f00450049005500410002001e004400450053004b0054004f0050002d00380037004f00450049005500410001001e004400450053004b0054004f0050002d00380037004f00450049005500410004001e004400450053004b0054004f0050002d00380037004f00450049005500410003001e004400450053004b0054004f0050002d00380037004f00450049005500410007000800f45a108a1da9db0100000000
>>> SMB WRITE 4 bytes: 0000020d
>>> SMB WRITE 525 bytes: fe534d42400001000000000001007e000000000000000000020000000000000000000000000000002d00000000bc0000000000000000000000000000000000001900000100000000000000005800b5010000000000000000a18201b1308201ada0030a0101a28201900482018c4e544c4d53535000030000001800180080000000e400e400980000001e001e00580000000a000a00760000000000000000000000100010007c010000158288e20a0000000000000f8e6adc824374df4b65004e4e2ac0c13d4400450053004b0054004f0050002d00380037004f00450049005500410047007500650073007400000000000000000000000000000000000000000000000000a100f0afe5ffb364f7713aca9391e4cf0101000000000000f45a108a1da9db014739e5b99e2ddfe20000000002001e004400450053004b0054004f0050002d00380037004f00450049005500410001001e004400450053004b0054004f0050002d00380037004f00450049005500410004001e004400450053004b0054004f0050002d00380037004f00450049005500410003001e004400450053004b0054004f0050002d00380037004f00450049005500410007000800f45a108a1da9db0106000400020000000a00100000000000000000000000000000000000000000000000000070b57ea705fa0298f45e171659a87394a3120410010000005081fffbb4835e2200000000
<<< SMB READ 4 bytes: 00000048
<<< SMB READ 72 bytes: fe534d4240000100720000c0010001000100000000000000020000000000000000000000000000002d00000000bc0000000000000000000000000000000000000900000000000000
[SMB test] Session error: response error: The referenced account is currently disabled and may not be logged on to.
[SMB test] Detected Windows version: 10.0.22621
<<< SMB READ 0 bytes: 
17:03:47 SMB检测结果为： Windows 10, Windows 11

检测详情:
----------------------------------------

[TCP检测结果]
操作系统选项: Windows 10, Windows XP, Windows 7
最后检测端口: 135
权重分配:
- Windows 10: 9
- Windows XP: 4
- Windows 7: 5

[SMB检测结果]
检测到Windows版本: 10.0.22621
根据build号(>=22000)判定为 Windows 11

[最终权重统计]
各操作系统权重:
- Windows 10: 9

[最终结果]
检测到的操作系统: Windows 10

判断依据:
1. SMB协议显示Windows版本号: 10.0.22621
2. Build号 22621 大于等于22000，符合Windows 11特征
3. 综合权重分析: Windows 10 获得最高权重 9
----------------------------------------

操作系统最终检测结果为： Windows 10
xuemian@MacBookPro osDetector % 
```

## 参考资料
- [NMAP](https://nmap.org/nmap-fingerprinting-article.txt)
- [RFC 793](https://datatracker.ietf.org/doc/html/rfc761)
- [RFC 9293](https://www.rfc-editor.org/info/rfc9293)